...renderHome(); };

const openDetail = (id) => { const app = apps.find(a => a.id === id); if(!app) return;

const modal = document.getElementById('detailModal');
const content = document.getElementById('detailContent');

const ratingList = app.ratings || [];
const avgRating = ratingList.length ? (ratingList.reduce((a,b)=>a+b.stars,0)/ratingList.length).toFixed(1) : 'No ratings';

content.innerHTML = `
    <span class="close-modal" onclick="closeModal('detailModal')">&times;</span>
    <div class="detail-header">
        <img src="${app.logo}" class="detail-logo">
        <div>
            <h2>${app.name}</h2>
            <p>by ${app.developer}</p>
            <p>Version: ${app.version}</p>
            <p>Size: ${formatSize(app.fileSize || 0)}</p>
            <p>Rating: ★ ${avgRating}</p>
        </div>
    </div>

    <button class="btn btn-primary download-btn ${app.isPremium ? '' : 'download-anim'}"
        onclick="${app.isPremium ? `initiatePurchase('${app.id}')` : `startDownloadProcess('${app.id}')`}">
        ${app.isPremium ? `Buy ₹${app.appPrice}` : 'Download'}
    </button>

    <p>${app.description}</p>

    <div class="screenshot-container">
        ${(app.screenshots || []).map(s => `<img src="${s}" class="screenshot-preview">`).join('')}
    </div>

    <div class="reviews-section">
        <h3>Reviews</h3>
        ${(ratingList.map(r => `
            <div class="review-item">
                <strong>${r.user}</strong> - ★ ${r.stars}
                <p>${r.comment}</p>
            </div>
        `)).join(''))}
        <hr>
        <h4>Add Review</h4>
        <div class="form-group">
            <select id="revStars">
                <option value="5">5 Stars</option>
                <option value="4">4 Stars</option>
                <option value="3">3 Stars</option>
                <option value="2">2 Stars</option>
                <option value="1">1 Star</option>
            </select>
        </div>
        <div class="form-group">
            <textarea id="revComment" rows="2" placeholder="Write review..."></textarea>
        </div>
        <button class="btn btn-success" onclick="submitReview('${app.id}')">Submit</button>
    </div>
`;
modal.classList.remove('hidden');

};

const submitReview = async (appId) => { const stars = parseInt(document.getElementById('revStars').value); const comment = document.getElementById('revComment').value; if(!comment) return alert("Write something");

const appRef = db.collection('apps').doc(appId);
const appDoc = await appRef.get();
const data = appDoc.data();
const ratings = data.ratings || [];
ratings.push({
    user: currentUser.displayName || currentUser.email,
    stars,
    comment
});
await appRef.update({ ratings });
alert("Review added!");

};

const initiatePurchase = (id) => { const app = apps.find(a => a.id === id); if(!app) return;

const upiId = app.uploaderUid === currentUser.uid ? '' : app.uploaderUpi || '';
const upiLink = `upi://pay?pa=${upiId}&pn=${app.developer}&am=${app.appPrice}&cu=INR&tn=AppPurchase`;

document.getElementById('upiPayBtn').href = upiLink;
document.getElementById('upiPayBtn').innerText = `Pay ₹${app.appPrice}`;
document.getElementById('payTitle').innerText = "Pay Developer";
document.getElementById('payReceiverInfo').innerText = "Payment goes to App Developer";

document.getElementById('payContext').value = 'purchase';
document.getElementById('payTargetId').value = id;

document.getElementById('paymentModal').classList.remove('hidden');

};

const startDownloadProcess = async (id) => { const app = apps.find(a => a.id === id); if(!app) return;

await db.collection('apps').doc(id).update({
    downloads: firebase.firestore.FieldValue.increment(1)
});

window.open(app.apkUrl, '_blank');

};

// ======================================================= // 5. ADMIN PANEL // ======================================================= const openAdminPrompt = () => { document.getElementById('adminLoginModal').classList.remove('hidden'); };

const checkAdmin = () => { const pass = document.getElementById('adminPass').value; if(pass === ADMIN_PASS) { document.getElementById('adminPanel').classList.remove('hidden'); document.getElementById('mainView').classList.add('hidden'); closeModal('adminLoginModal'); showAdminTab('pending'); } else { alert("Wrong password"); } };

const exitAdmin = () => { document.getElementById('adminPanel').classList.add('hidden'); document.getElementById('mainView').classList.remove('hidden'); };

const showAdminTab = (tab) => { const container = document.getElementById('adminTabContent'); document.querySelectorAll('.admin-tabs .btn').forEach(b => b.classList.remove('btn-primary')); event.target.classList.add('btn-primary');

if(tab === 'pending') {
    const pending = apps.filter(a => a.status === 'pending');
    container.innerHTML = buildAdminTable(pending, true);
} else if(tab === 'approved') {
    const approved = apps.filter(a => a.status === 'approved');
    container.innerHTML = buildAdminTable(approved, false);
} else if(tab === 'analytics') {
    const total = apps.length;
    const approved = apps.filter(a => a.status === 'approved').length;
    const downloads = apps.reduce((a,b)=>a+b.downloads,0);
    container.innerHTML = `
        <h3>Total Apps: ${total}</h3>
        <h3>Approved Apps: ${approved}</h3>
        <h3>Total Downloads: ${downloads}</h3>
    `;
}

};

const buildAdminTable = (list, allowApprove) => { if(list.length === 0) return "<p>No data</p>"; let rows = list.map(app => <tr> <td>${app.name}</td> <td>${app.developer}</td> <td>${app.category}</td> <td>${app.downloads}</td> <td> ${allowApprove ?<button class="btn btn-success" onclick="approveApp('${app.id}')">Approve</button>: ''} <button class="btn btn-danger" onclick="deleteApp('${app.id}')">Delete</button> </td> </tr>).join(''); return <table class="admin-table"> <tr> <th>Name</th><th>Dev</th><th>Category</th><th>Downloads</th><th>Actions</th> </tr> ${rows} </table>; };

const approveApp = async (id) => { await db.collection('apps').doc(id).update({ status: 'approved' }); alert("App Approved"); };

const deleteApp = async (id) => { await db.collection('apps').doc(id).delete(); alert("App Deleted"); }; </script>

</body>
</html>
