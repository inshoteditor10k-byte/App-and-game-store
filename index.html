<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>App Plus Game Store</title>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<style>
    :root {
        --primary: #ff9933;
        --secondary: #138808;
        --accent: #000080;
        --bg-light: #f4f6f9;
        --text-light: #1a1a1a;
        --card-light: #ffffff;
        --bg-dark: #121212;
        --text-dark: #e0e0e0;
        --card-dark: #1e1e1e;
        --glass: rgba(255, 255, 255, 0.1);
        --shadow: 0 4px 6px rgba(0,0,0,0.1);
        --radius: 12px;
        --transition: all 0.3s ease;
    }

    body.dark-mode {
        --bg-color: var(--bg-dark);
        --text-color: var(--text-dark);
        --card-bg: var(--card-dark);
        --border-color: #333;
    }

    body {
        --bg-color: var(--bg-light);
        --text-color: var(--text-light);
        --card-bg: var(--card-light);
        --border-color: #ddd;
        margin: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        transition: var(--transition);
        padding-bottom: 80px;
    }

    /* Utils */
    .hidden { display: none !important; }
    .flex { display: flex; }
    .grid { display: grid; }
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: var(--radius);
        cursor: pointer;
        font-weight: 600;
        transition: var(--transition);
        display: inline-flex;
        align-items: center;
        gap: 8px;
        justify-content: center;
    }
    .btn-primary { background: linear-gradient(135deg, var(--primary), #ff7700); color: white; }
    .btn-secondary { background: #e0e0e0; color: #333; }
    .btn-danger { background: #ff4444; color: white; }
    .btn-success { background: var(--secondary); color: white; }
    .btn:hover { transform: translateY(-2px); opacity: 0.9; }
    .btn:disabled { background: #ccc; cursor: not-allowed; }


    /* Login Screen Styles */
    #authScreen {
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background: linear-gradient(135deg, #121212, #2d2d2d);
    }
    .auth-box {
        background: var(--card-light);
        padding: 2rem;
        border-radius: 20px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        text-align: center;
    }
    .auth-box h1 { color: var(--primary); margin-bottom: 5px; }
    .auth-box input {
        width: 100%; padding: 12px; margin: 10px 0;
        border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box;
    }
    .btn-google {
        background: white; color: #333; border: 1px solid #ccc;
        width: 100%; margin-top: 15px; display: flex; justify-content: center; gap: 10px;
    }
    
    /* Profile Styles */
    .profile-avatar { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; object-fit: cover; border: 2px solid var(--primary); }
    .stat-box {
        background: rgba(255, 153, 51, 0.1);
        padding: 15px; border-radius: 10px;
        text-align: center; flex: 1;
        border: 1px solid var(--primary);
    }

    /* Header */
    header {
        padding: 1rem 5%;
        background: var(--card-bg);
        box-shadow: var(--shadow);
        position: sticky;
        top: 0;
        z-index: 100;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .logo { font-size: 1.5rem; font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 10px; }
    .logo span { color: var(--accent); }
    .search-bar {
        flex-grow: 1;
        max-width: 500px;
        margin: 0 20px;
        position: relative;
    }
    .search-bar input {
        width: 100%;
        padding: 12px 20px;
        border-radius: 50px;
        border: 1px solid var(--border-color);
        background: var(--bg-color);
        color: var(--text-color);
        outline: none;
    }

    /* Hero */
    .section-title { margin: 2rem 5% 1rem; font-size: 1.8rem; border-left: 5px solid var(--primary); padding-left: 15px; }
    .categories { padding: 0 5%; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
    .cat-btn { padding: 8px 16px; border-radius: 20px; background: var(--card-bg); border: 1px solid var(--border-color); cursor: pointer; }
    .cat-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

    /* Grids */
    .app-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        padding: 0 5% 4rem;
    }

    /* App Card */
    .app-card {
        background: var(--card-bg);
        border-radius: var(--radius);
        padding: 15px;
        box-shadow: var(--shadow);
        display: flex;
        gap: 15px;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
        border: 1px solid var(--border-color);
    }
    .app-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.15); }
    .app-logo { width: 80px; height: 80px; border-radius: 15px; object-fit: cover; background: #eee; }
    .app-details { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
    .app-name { font-size: 1.2rem; font-weight: bold; margin: 0; }
    .app-dev { font-size: 0.9rem; color: #888; margin: 5px 0; }
    .app-meta { font-size: 0.8rem; display: flex; gap: 10px; align-items: center; margin-top: auto; }
    .rating-stars { color: #f1c40f; }
    .badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; }
    .badge-trend { background: #ff4757; color: white; }
    .badge-feat { background: #2ed573; color: white; }
    .badge-ad { border: 1px solid #ccc; color: #888; }
    
    /* Modal */
    .modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 1000;
        display: flex; justify-content: center; align-items: center;
        backdrop-filter: blur(5px);
    }
    .modal-content {
        background: var(--card-bg);
        width: 90%; max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
        border-radius: var(--radius);
        padding: 25px;
        position: relative;
        animation: slideUp 0.3s ease;
    }
    @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .close-modal { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; }

    /* PROGRESS BAR STYLES */
    .progress-container {
        width: 100%;
        background-color: #e0e0e0;
        border-radius: 10px;
        margin-top: 15px;
        height: 20px;
        overflow: hidden;
    }
    .progress-bar {
        width: 0%;
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        transition: width 0.2s ease;
        text-align: center;
        line-height: 20px;
        color: white;
        font-size: 12px;
        font-weight: bold;
    }

    /* Forms */
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
    .form-group input, .form-group textarea, .form-group select {
        width: 100%; padding: 10px;
        border-radius: 8px; border: 1px solid var(--border-color);
        background: var(--bg-color); color: var(--text-color); box-sizing: border-box;
    }
    .screenshot-container { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; }
    .screenshot-preview { height: 100px; border-radius: 8px; }
    .upload-step-nav { display: flex; justify-content: space-between; margin-top: 20px; }


    /* Admin */
    .admin-dashboard { padding: 20px 5%; }
    .admin-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .admin-table { width: 100%; border-collapse: collapse; }
    .admin-table th, .admin-table td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border-color); }

    /* Details View */
    .detail-header { display: flex; gap: 20px; margin-bottom: 20px; }
    .detail-logo { width: 120px; height: 120px; border-radius: 20px; }
    .download-btn { width: 100%; margin: 15px 0; font-size: 1.1rem; justify-content: center; }
    .download-anim { animation: pulse 1s infinite; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    
    .reviews-section { margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 20px; }
    .review-item { background: rgba(0,0,0,0.05); padding: 10px; border-radius: 8px; margin-bottom: 10px; }

    /* Footer */
    footer { text-align: center; padding: 2rem; background: var(--card-bg); margin-top: 2rem; color: #777; font-size: 0.9rem; }
    
    /* Monetization Placeholders */
    .premium-badge { position: absolute; top: 10px; right: 10px; background: gold; color: black; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }
    .premium-price-tag {
        position: absolute; bottom: 10px; right: 10px; background: var(--primary); color: white; padding: 4px 8px; border-radius: 8px; font-size: 0.8rem; font-weight: bold;
    }

    /* Payment Styles */
    .payment-alert {
        background: rgba(255, 68, 68, 0.1); border: 1px solid red;
        color: red; padding: 10px; border-radius: 8px; font-size: 0.85rem;
        margin-bottom: 15px; font-weight: bold; text-align: left;
    }
    .upi-direct-btn {
        display: block; width: 100%; text-decoration: none; text-align: center;
        margin-bottom: 20px; font-size: 1.1rem; padding: 15px; box-sizing: border-box;
        border-radius: var(--radius);
        background: var(--primary); color: white; font-weight: bold;
    }
</style>
</head>
<body>

<!-- AUTH SCREEN (Login) -->
<div id="authScreen">
    <div class="auth-box">
        <div class="logo" style="justify-content:center; margin-bottom:20px;">
            <svg width="30" height="30" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5l-2.5 1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z"/></svg>
            AppPlus <span>Store</span>
        </div>
        
        <div id="loginForm">
            <h3>Welcome Back</h3>
            <input type="email" id="loginEmail" placeholder="Email Address">
            <input type="password" id="loginPass" placeholder="Password">
            <button class="btn btn-primary" onclick="emailLogin()" style="width:100%">Login</button>
            <p style="font-size:0.9rem;">New here? <a href="#" onclick="toggleAuthMode()" style="color:var(--primary);">Sign Up</a></p>
        </div>

        <div id="signupForm" class="hidden">
            <h3>Create Account</h3>
            <input type="text" id="regName" placeholder="Full Name">
            <input type="email" id="regEmail" placeholder="Email Address">
            <input type="password" id="regPass" placeholder="Set Password">
            <button class="btn btn-primary" onclick="emailSignup()" style="width:100%">Sign Up</button>
            <p style="font-size:0.9rem;">Existing user? <a href="#" onclick="toggleAuthMode()" style="color:var(--primary);">Login</a></p>
        </div>

        <hr style="margin:20px 0; opacity:0.3;">
        
        <button class="btn btn-google" onclick="googleLogin()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">
            Continue with Google
        </button>
    </div>
</div>

<!-- MAIN APP INTERFACE (Hidden by default) -->
<div id="mainInterface" class="hidden">
    <header>
        <div class="logo">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5l-2.5 1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z"/></svg>
            AppPlus <span>Store</span>
        </div>
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search by tags (e.g., Action, Tool, AI)..." onkeyup="handleSearch()">
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
            <button class="btn btn-secondary" onclick="toggleTheme()" id="themeBtn">ðŸŒ™</button>
            <button class="btn btn-primary" onclick="openUploadModal()">Submit App</button>
            <img id="headerAvatar" src="https://via.placeholder.com/40" class="profile-avatar" onclick="openProfileModal()">
        </div>
    </header>

    <main id="mainView">
        <div class="section-title">Featured & Trending</div>
        <div class="app-grid" id="featuredGrid"></div>

        <div class="categories" id="categoryFilters">
            <button class="cat-btn active" onclick="filterCategory('All')">All</button>
            <button class="cat-btn" onclick="filterCategory('Game')">Games</button>
            <button class="cat-btn" onclick="filterCategory('Tool')">Tools</button>
            <button class="cat-btn" onclick="filterCategory('Education')">Education</button>
            <button class="cat-btn" onclick="filterCategory('AI')">AI</button>
            <button class="cat-btn" onclick="filterCategory('Utility')">Utility</button>
        </div>

        <div class="section-title">All Apps</div>
        <div class="app-grid" id="appGrid"></div>
    </main>

    <footer onclick="openAdminPrompt()">
        <p>&copy; 2026 App Plus Game Store. Made for India.</p>
        <p style="opacity:0.5; font-size:0.7rem;">Click footer for Admin</p>
        <p style="margin-top:10px; color: var(--primary);">Donate via UPI: 6206319727@fam</p>
    </footer>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="modal hidden">
    <div class="modal-content" style="text-align:center;">
        <span class="close-modal" onclick="closeModal('profileModal')">&times;</span>
        <img id="pAvatar" src="" style="width:100px; height:100px; border-radius:50%; border:3px solid var(--primary); margin-bottom:10px;">
        <h2 id="pName">User Name</h2>
        <p id="pEmail" style="color:gray; margin-bottom:20px;"></p>

        <div class="flex" style="gap:10px; margin-bottom:20px;">
            <div class="stat-box"><h3 id="pUploads">0</h3><small>Uploads</small></div>
            <div class="stat-box"><h3 id="pEarnings">â‚¹0</h3><small>Total Earnings</small></div>
        </div>

        <div class="form-group" style="text-align:left;">
            <label>Your UPI ID (To receive payments)</label>
            <div class="flex" style="gap:5px;">
                <input type="text" id="userUpi" placeholder="e.g. name@okaxis">
                <button class="btn btn-secondary" onclick="saveUserUpi()">Save</button>
            </div>
            <small style="color:var(--primary);">Compulsory for earning from Premium Apps</small>
        </div>

        <button class="btn btn-danger" onclick="logout()" style="width:100%; margin-top:20px; font-weight:bold;">ðŸšª Logout</button>
    </div>
</div>

<!-- ======================= MODIFIED UPLOAD MODAL ======================= -->
<div id="uploadModal" class="modal hidden">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('uploadModal')">&times;</span>
        <h2 id="uploadModalTitle">Submit Your App (Step 1 of 4)</h2>
        
        <form id="uploadForm">
            <!-- STEP 1: Details -->
            <div id="uploadStep1">
                <div class="form-group"><label>App Name *</label><input type="text" id="uName" required></div>
                <div class="form-group"><label>Developer Name *</label><input type="text" id="uDev" required></div>
                <div class="form-group"><label>Email (Optional)</label><input type="email" id="uEmail"></div>
                <div class="flex" style="gap:10px;">
                    <div class="form-group" style="flex:1;"><label>Category *</label><select id="uCat"><option value="Game">Game</option><option value="Tool">Tool</option><option value="Education">Education</option><option value="AI">AI</option><option value="Utility">Utility</option><option value="Other">Other</option></select></div>
                    <div class="form-group" style="flex:1;"><label>Version *</label><input type="text" id="uVer" placeholder="v1.0" required></div>
                </div>
                <div class="form-group"><label>Description *</label><textarea id="uDesc" rows="3" required></textarea></div>
                <div class="form-group"><label>Tags (Comma separated) *</label><input type="text" id="uTags" placeholder="Action, RPG, Calculator..." required></div>
                <div class="upload-step-nav"><span></span><button type="button" class="btn btn-primary" onclick="handleDetailsSubmit()">Next: Upload Logo</button></div>
            </div>

            <!-- STEP 2: Logo -->
            <div id="uploadStep2" class="hidden">
                <div class="form-group"><label>App Logo (Square) *</label><input type="file" id="uLogo" accept="image/*" required></div>
                <div class="upload-step-nav">
                    <button type="button" class="btn btn-secondary" onclick="goToStep(1)">Back</button>
                    <button type="button" class="btn btn-primary" id="logoUploadBtn" onclick="handleLogoUpload()">Next: Upload Screenshots</button>
                </div>
            </div>

            <!-- STEP 3: Screenshots -->
            <div id="uploadStep3" class="hidden">
                <div class="form-group">
                    <label>Screenshots</label>
                    <div id="screenshotInputs"><input type="file" class="ss-input" accept="image/*" style="margin-bottom:5px;"></div>
                    <button type="button" class="btn btn-secondary" onclick="addScreenshotField()" style="font-size:0.8rem; margin-top:5px;">+ Add More</button>
                </div>
                <div class="upload-step-nav">
                    <button type="button" class="btn btn-secondary" onclick="goToStep(2)">Back</button>
                    <button type="button" class="btn btn-primary" id="ssUploadBtn" onclick="handleScreenshotsUpload()">Next: Upload APK</button>
                </div>
            </div>
            
            <!-- STEP 4: APK & Payment -->
            <div id="uploadStep4" class="hidden">
                 <div class="form-group"><label>APK File *</label><input type="file" id="uApk" required></div>
                 <hr>
                 <div class="form-group" style="padding: 10px; border: 1px dashed var(--primary); border-radius: 8px;">
                    <label style="display:flex; align-items:center; gap:10px; cursor:pointer;"><input type="checkbox" id="uIsPremium" onchange="togglePremiumInput()"> Is this a Premium App?</label>
                    <div id="priceInputDiv" class="hidden" style="margin-top:10px;"><label>App Price for Users (â‚¹)</label><input type="number" id="uPrice" placeholder="e.g. 50"><small style="color:var(--primary); display:block; margin-top:5px;"><b>Note:</b> Listing Fee for Premium App is â‚¹100.</small></div>
                    <div id="freeInfoDiv" style="margin-top:5px;"><small style="color:green;">Listing Fee for Free App is â‚¹10.</small></div>
                </div>
                 <div class="upload-step-nav">
                    <button type="button" class="btn btn-secondary" onclick="goToStep(3)">Back</button>
                    <button type="button" class="btn btn-primary" id="apkUploadBtn" onclick="handleApkUpload()">Upload & Proceed to Payment</button>
                </div>
            </div>
        </form>
        
        <!-- Universal Progress Bar -->
        <div id="uploadProgressContainer" class="hidden" style="margin-top:20px;">
            <p id="uploadProgressText" style="text-align:center; margin-bottom:5px; font-size:0.9rem;">Starting Upload...</p>
            <div class="progress-container"><div id="uploadProgressBar" class="progress-bar">0%</div></div>
        </div>
    </div>
</div>

<!-- Payment Verification Modal -->
<div id="paymentModal" class="modal hidden">
    <div class="modal-content" style="text-align:center;">
        <h2 style="color:var(--primary);" id="payTitle">Payment Required</h2>
        <p id="payReceiverInfo" style="margin-bottom:10px;">Payment goes to Admin/Developer</p>
        <a id="upiPayBtn" href="#" class="btn btn-primary upi-direct-btn">Pay Now via UPI App</a>
        <div class="payment-alert">WARNING: After payment, you MUST enter the EXACT Name & UPI ID shown in your payment history. If details do not match, verification will fail.</div>
        <form onsubmit="finalizeTransaction(event)">
            <h4 style="text-align:left; margin-bottom:10px;">Confirm Transaction Details</h4>
            <div class="form-group"><label>Sender Name (Your Bank Name) *</label><input type="text" id="paySenderName" placeholder="e.g. Rahul Kumar" required></div>
            <div class="form-group"><label>Sender UPI ID *</label><input type="text" id="paySenderUpi" placeholder="e.g. rahul@oksbi" required></div>
            <input type="hidden" id="payContext" value=""><input type="hidden" id="payTargetId" value="">
            <div class="flex" style="gap:10px;"><button type="button" class="btn btn-secondary" style="flex:1;" onclick="closeModal('paymentModal')">Cancel</button><button type="submit" class="btn btn-success" style="flex:1;">Submit Verification</button></div>
        </form>
    </div>
</div>

<!-- App Detail Modal -->
<div id="detailModal" class="modal hidden"><div class="modal-content" id="detailContent"></div></div>

<!-- Admin Login Modal -->
<div id="adminLoginModal" class="modal hidden">
    <div class="modal-content" style="max-width:300px; text-align:center;">
        <span class="close-modal" onclick="closeModal('adminLoginModal')">&times;</span>
        <h3>Admin Access</h3>
        <div class="form-group"><input type="password" id="adminPass" placeholder="Enter Password"></div>
        <button class="btn btn-primary" onclick="checkAdmin()">Login</button>
    </div>
</div>

<!-- Admin Panel -->
<div id="adminPanel" class="hidden admin-dashboard">
    <header style="background:none; box-shadow:none; padding:0; margin-bottom:20px;">
        <h2>Admin Dashboard</h2>
        <button class="btn btn-secondary" onclick="exitAdmin()">Exit</button>
    </header>
    <div class="admin-tabs">
        <button class="btn btn-primary" onclick="showAdminTab('pending')">Pending</button>
        <button class="btn btn-secondary" onclick="showAdminTab('approved')">Approved</button>
        <button class="btn btn-secondary" onclick="showAdminTab('analytics')">Analytics</button>
    </div>
    <div id="adminTabContent"></div>
</div>

<script>
// ==========================================
// ðŸ”´ IMPORTANT: FIREBASE CONFIGURATION ðŸ”´
// ==========================================
const firebaseConfig = {
  apiKey: "AIzaSyDpF0VyF-4MeniRCO1L1oMhYtR5uBZkklU",
  authDomain: "apps-and-games-store-8c442.firebaseapp.com",
  databaseURL: "https://apps-and-games-store-8c442-default-rtdb.firebaseio.com",
  projectId: "apps-and-games-store-8c442",
  storageBucket: "apps-and-games-store-8c442.firebasestorage.app",
  messagingSenderId: "320735195272",
  appId: "1:320735195272:web:f6d8693160baf6eaf8af3d"
};

try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Firebase Init Error"); }
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

const ADMIN_PASS = "ss620631";
const ADMIN_UPI = "6206319727@fam"; 
let apps = []; 
let currentUser = null;
let currentCategory = 'All';
let tempAppData = {}; 

// =======================================================
// 1. AUTHENTICATION & PROFILE LOGIC (UNCHANGED)
// =======================================================
auth.onAuthStateChanged(async(user) => {
    if (user) {
        currentUser = user;
        document.getElementById('authScreen').classList.add('hidden');
        document.getElementById('mainInterface').classList.remove('hidden');
        if (document.getElementById('headerAvatar')) document.getElementById('headerAvatar').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || user.email}`;
        const userRef = db.collection('users').doc(user.uid);
        const doc = await userRef.get();
        if (!doc.exists) {
            await userRef.set({ name: user.displayName || user.email.split('@')[0], email: user.email, photo: user.photoURL, upiId: '', earnings: 0 });
        }
        if (document.getElementById('uDev')) document.getElementById('uDev').value = user.displayName || user.email.split('@')[0];
        if (document.getElementById('uEmail')) document.getElementById('uEmail').value = user.email;
        loadAppsFromDB();
    } else {
        currentUser = null;
        document.getElementById('authScreen').classList.remove('hidden');
        document.getElementById('mainInterface').classList.add('hidden');
    }
});
const toggleAuthMode = () => { document.getElementById('loginForm').classList.toggle('hidden'); document.getElementById('signupForm').classList.toggle('hidden'); };
const emailLogin = () => { const e = document.getElementById('loginEmail').value, p = document.getElementById('loginPass').value; auth.signInWithEmailAndPassword(e, p).catch(e => alert(e.message)); };
const emailSignup = () => { const e = document.getElementById('regEmail').value, p = document.getElementById('regPass').value, n = document.getElementById('regName').value; auth.createUserWithEmailAndPassword(e, p).then(c => c.user.updateProfile({ displayName: n })).catch(e => alert(e.message)); };
const googleLogin = () => { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => alert(e.message)); };
const logout = () => { closeModal('profileModal'); auth.signOut(); };
const openProfileModal = async() => {
    if (!currentUser) return;
    const userRef = await db.collection('users').doc(currentUser.uid).get();
    const data = userRef.data();
    const myApps = apps.filter(a => a.uploaderUid === currentUser.uid);
    document.getElementById('pAvatar').src = currentUser.photoURL || `https://ui-avatars.com/api/?name=${data.name}`;
    document.getElementById('pName').innerText = data.name || 'User';
    document.getElementById('pEmail').innerText = currentUser.email;
    document.getElementById('userUpi').value = data.upiId || '';
    document.getElementById('pUploads').innerText = myApps.length;
    document.getElementById('pEarnings').innerText = `â‚¹${data.earnings || 0}`;
    document.getElementById('profileModal').classList.remove('hidden');
};
const saveUserUpi = async() => { const upi = document.getElementById('userUpi').value; if (!upi.includes('@')) return alert("Invalid UPI ID"); await db.collection('users').doc(currentUser.uid).update({ upiId: upi }); alert("UPI ID Saved!"); };

// =======================================================
// 2. APP LOAD & DISPLAY LOGIC (UNCHANGED)
// =======================================================
document.addEventListener('DOMContentLoaded', () => initTheme());
const loadAppsFromDB = () => { db.collection("apps").onSnapshot(q => { apps = []; q.forEach(doc => { let d = doc.data(); d.id = doc.id; apps.push(d); }); renderHome(); }); };
const initTheme = () => { if (localStorage.getItem('theme') === 'dark') { document.body.classList.add('dark-mode'); document.getElementById('themeBtn').innerText = 'â˜€ï¸'; } else { document.body.classList.remove('dark-mode'); document.getElementById('themeBtn').innerText = 'ðŸŒ™'; } };
const toggleTheme = () => { document.body.classList.toggle('dark-mode'); const i = document.body.classList.contains('dark-mode'); localStorage.setItem('theme', i ? 'dark' : 'light'); document.getElementById('themeBtn').innerText = i ? 'â˜€ï¸' : 'ðŸŒ™'; };
const formatSize = b => { if (b === 0) return '0 B'; const k=1024, s=['B','KB','MB','GB'], i=Math.floor(Math.log(b)/Math.log(k)); return parseFloat((b/Math.pow(k, i)).toFixed(2))+' '+s[i]; };
const closeModal = id => document.getElementById(id).classList.add('hidden');
const addScreenshotField = () => { const d = document.createElement('input'); d.type = 'file'; d.className = 'ss-input'; d.accept = 'image/*'; d.style.cssText = 'margin-bottom:5px;display:block;'; document.getElementById('screenshotInputs').appendChild(d); };
const togglePremiumInput = () => { const i = document.getElementById('uIsPremium').checked; document.getElementById('priceInputDiv').classList.toggle('hidden', !i); document.getElementById('freeInfoDiv').classList.toggle('hidden', i); };
const filterCategory = cat => { currentCategory = cat; document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active'); renderHome(); };
const handleSearch = () => renderHome();
const renderHome = () => { const g = document.getElementById('appGrid'), f = document.getElementById('featuredGrid'); g.innerHTML = ''; f.innerHTML = ''; const a = apps.filter(app => app.status === 'approved'); const t = [...a].sort((x, y) => y.downloads - x.downloads).slice(0, 3); const F = a.filter(app => app.featured); const d = new Set([...t, ...F]); Array.from(d).forEach(app => f.appendChild(createAppCard(app, true))); const q = document.getElementById('searchInput').value.toLowerCase(); const l = a.filter(app => (app.tags && app.tags.some(tg => tg.toLowerCase().includes(q))) && (currentCategory === 'All' || app.category === currentCategory)); if (l.length === 0) g.innerHTML = '<p>No apps found.</p>'; else l.forEach(app => g.appendChild(createAppCard(app))); };
const createAppCard = (app, isHighlight = false) => { const d = document.createElement('div'); d.className = 'app-card'; d.onclick = () => openDetail(app.id); const r = app.ratings || []; const a = r.length ? (r.reduce((x, y) => x + y.stars, 0) / r.length).toFixed(1) : 'New'; d.innerHTML = `<img src="${app.logo}" class="app-logo" alt="logo"><div class="app-details"><h3 class="app-name">${app.name}</h3><p class="app-dev">by ${app.developer}</p><div class="app-meta"><span class="rating-stars">â˜… ${a}</span><span>â¬‡ ${app.downloads}</span>${isHighlight ? '<span class="badge badge-trend">ðŸ”¥ Hot</span>' : ''}<span class="badge badge-ad">${app.category}</span></div></div>${app.featured ? '<div class="premium-badge">Featured</div>' : ''}${app.isPremium ? `<div class="premium-price-tag">â‚¹${app.appPrice}</div>` : ''}`; return d; };
const openDetail = (id) => { const app = apps.find(a => a.id === id); if (!app) return; const modal = document.getElementById('detailModal'); const content = document.getElementById('detailContent'); const ratingList = app.ratings || []; const avgRating = ratingList.length ? (ratingList.reduce((a, b) => a + b.stars, 0) / ratingList.length).toFixed(1) : '0.0'; const isOwner = currentUser && currentUser.uid === app.uploaderUid; let actionButton = isOwner ? `<button class="btn btn-secondary download-btn">You Own This App</button>` : app.isPremium ? `<button class="btn btn-primary download-btn" onclick="initiatePurchase('${app.id}')">Buy for â‚¹${app.appPrice}</button>` : `<button class="btn btn-primary download-btn" id="dlBtn" onclick="startDownloadProcess('${app.id}')">Download Now (${formatSize(app.fileSize)})</button>`; const screenshotsHtml = app.screenshots ? app.screenshots.map(s => `<img src="${s}" class="screenshot-preview">`).join('') : ''; const reviewsHtml = ratingList.map(r => `<div class="review-item"><div style="display:flex; justify-content:space-between;"><strong>${'â˜…'.repeat(r.stars)}</strong><small>${new Date(r.date).toLocaleDateString()}</small></div><p>${r.comment}</p></div>`).join(''); content.innerHTML = `<span class="close-modal" onclick="closeModal('detailModal')">&times;</span><div class="detail-header"><img src="${app.logo}" class="detail-logo"><div><h1>${app.name}</h1><p style="color:var(--primary); font-weight:bold;">${app.developer}</p><p>${app.category} â€¢ v${app.version} â€¢ ${formatSize(app.fileSize)}</p><div style="margin-top:5px;"><span class="rating-stars" style="font-size:1.2rem">â˜… ${avgRating}</span> <span style="opacity:0.7">(${ratingList.length} reviews)</span></div></div></div><div class="screenshot-container">${screenshotsHtml}</div><p style="margin:20px 0; line-height:1.6;">${app.description}</p>${actionButton}<div class="reviews-section"><h3>Rate & Review</h3><div class="form-group"><select id="rStars" style="width:100px;"><option value="5">â˜…â˜…â˜…â˜…â˜…</option><option value="4">â˜…â˜…â˜…â˜…</option><option value="3">â˜…â˜…â˜…</option><option value="2">â˜…â˜…</option><option value="1">â˜…</option></select><input type="text" id="rComment" placeholder="Write a review..." style="margin-top:5px;"><button class="btn btn-secondary" onclick="submitReview('${app.id}')" style="margin-top:5px;">Post</button></div><div id="reviewsList">${reviewsHtml}</div></div>`; modal.classList.remove('hidden'); };

// =======================================================
// 3. NEW STEP-BY-STEP UPLOAD LOGIC
// =======================================================
const openUploadModal = () => {
    document.getElementById('uploadForm').reset();
    tempAppData = {};
    goToStep(1, false); // Go to first step without animation
    document.getElementById('uploadProgressContainer').classList.add('hidden');
    document.getElementById('uploadModal').classList.remove('hidden');
};

const goToStep = (step) => {
    const title = document.getElementById('uploadModalTitle');
    const stepTitles = ["Details", "Logo", "Screenshots", "APK & Payment"];
    title.innerText = `Submit Your App (Step ${step} of 4: ${stepTitles[step-1]})`;

    document.querySelectorAll('#uploadForm > div').forEach(div => div.classList.add('hidden'));
    document.getElementById(`uploadStep${step}`).classList.remove('hidden');
    
    // Hide progress bar when navigating between steps
    document.getElementById('uploadProgressContainer').classList.add('hidden');
};

const handleDetailsSubmit = () => {
    const name = document.getElementById('uName').value;
    const dev = document.getElementById('uDev').value;
    const cat = document.getElementById('uCat').value;
    const ver = document.getElementById('uVer').value;
    const desc = document.getElementById('uDesc').value;
    const tags = document.getElementById('uTags').value;
    
    if (!name || !dev || !cat || !ver || !desc || !tags) {
        return alert('Please fill all required fields.');
    }
    
    tempAppData.name = name;
    tempAppData.developer = dev;
    tempAppData.email = document.getElementById('uEmail').value;
    tempAppData.category = cat;
    tempAppData.version = ver;
    tempAppData.description = desc;
    tempAppData.tags = tags.split(',').map(t => t.trim());
    
    goToStep(2);
};

// Generic file upload helper
const uploadFileWithProgress = (file, path, progressTextEl, progressBarEl, buttonEl) => {
    return new Promise((resolve, reject) => {
        buttonEl.disabled = true;
        const ref = storage.ref(path);
        const task = ref.put(file);
        
        task.on('state_changed', 
            (snapshot) => {
                const percentage = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                progressBarEl.style.width = percentage + '%';
                progressBarEl.innerText = percentage + '%';
                progressTextEl.innerText = `Uploading ${file.name}: ${formatSize(snapshot.bytesTransferred)} / ${formatSize(snapshot.totalBytes)}`;
            },
            (error) => {
                buttonEl.disabled = false;
                reject(error);
            },
            async () => {
                const url = await task.snapshot.ref.getDownloadURL();
                progressTextEl.innerText = "Upload Complete!";
                progressBarEl.style.background = '#2ed573'; // Green on success
                buttonEl.disabled = false;
                resolve(url);
            }
        );
    });
};

const handleLogoUpload = async () => {
    const logoFile = document.getElementById('uLogo').files[0];
    if (!logoFile) return alert('Please select a logo file.');
    
    const progressContainer = document.getElementById('uploadProgressContainer');
    const progressText = document.getElementById('uploadProgressText');
    const progressBar = document.getElementById('uploadProgressBar');
    const btn = document.getElementById('logoUploadBtn');
    
    progressContainer.classList.remove('hidden');
    progressBar.style.background = 'linear-gradient(90deg, var(--primary), var(--secondary))'; // Reset color

    try {
        const ts = Date.now();
        const logoUrl = await uploadFileWithProgress(logoFile, `logos/${ts}_${logoFile.name}`, progressText, progressBar, btn);
        tempAppData.logo = logoUrl;
        setTimeout(() => goToStep(3), 500); // Go to next step after a short delay
    } catch (err) {
        alert('Logo upload failed. Please try again.');
        console.error(err);
    }
};

const handleScreenshotsUpload = async () => {
    const ssInputs = document.querySelectorAll('.ss-input');
    const validSsFiles = [];
    ssInputs.forEach(input => { if (input.files[0]) validSsFiles.push(input.files[0]); });
    
    if (validSsFiles.length === 0) {
        tempAppData.screenshots = [];
        return goToStep(4); // No screenshots, just skip
    }
    
    const progressContainer = document.getElementById('uploadProgressContainer');
    const progressText = document.getElementById('uploadProgressText');
    const progressBar = document.getElementById('uploadProgressBar');
    const btn = document.getElementById('ssUploadBtn');
    
    progressContainer.classList.remove('hidden');
    progressBar.style.background = 'linear-gradient(90deg, var(--primary), var(--secondary))';
    btn.disabled = true;
    
    try {
        const ts = Date.now();
        progressText.innerText = `Uploading ${validSsFiles.length} screenshots...`;
        
        const ssPromises = validSsFiles.map((file, index) => {
            const ref = storage.ref(`screens/${ts}_${index}_${file.name}`);
            return ref.put(file).then(() => ref.getDownloadURL());
        });

        const screenshotUrls = await Promise.all(ssPromises);
        tempAppData.screenshots = screenshotUrls;
        progressBar.style.width = '100%';
        progressBar.innerText = '100%';
        progressText.innerText = "Screenshots uploaded successfully!";
        progressBar.style.background = '#2ed573';
        
        setTimeout(() => goToStep(4), 500);
    } catch (err) {
        alert('Screenshot upload failed.');
        console.error(err);
    } finally {
        btn.disabled = false;
    }
};

const handleApkUpload = async () => {
    const apkFile = document.getElementById('uApk').files[0];
    if (!apkFile) return alert('Please select an APK file.');

    const isPremium = document.getElementById('uIsPremium').checked;
    const appPrice = isPremium ? document.getElementById('uPrice').value : 'Free';
    if(isPremium && !appPrice) return alert('Please enter a price for the premium app.');

    const progressContainer = document.getElementById('uploadProgressContainer');
    const progressText = document.getElementById('uploadProgressText');
    const progressBar = document.getElementById('uploadProgressBar');
    const btn = document.getElementById('apkUploadBtn');
    
    progressContainer.classList.remove('hidden');
    progressBar.style.background = 'linear-gradient(90deg, var(--primary), var(--secondary))';

    try {
        const ts = Date.now();
        const apkUrl = await uploadFileWithProgress(apkFile, `apks/${ts}_${apkFile.name}`, progressText, progressBar, btn);
        
        // Finalize tempAppData before payment
        tempAppData.apkUrl = apkUrl;
        tempAppData.fileSize = apkFile.size;
        tempAppData.isPremium = isPremium;
        tempAppData.appPrice = appPrice;
        tempAppData.listingFee = isPremium ? 100 : 10;
        tempAppData.downloads = 0;
        tempAppData.status = 'pending'; 
        tempAppData.featured = false;
        tempAppData.ratings = [];
        tempAppData.uploaderUid = currentUser.uid; 
        tempAppData.date = new Date().toISOString();
        
        // Setup and show payment modal
        initiateUploadPayment();

    } catch (err) {
        alert('APK upload failed. Please try again.');
        console.error(err);
    }
};

const initiateUploadPayment = () => {
    const fee = tempAppData.listingFee;
    const upiLink = `upi://pay?pa=${ADMIN_UPI}&pn=AppPlusAdmin&am=${fee}&cu=INR&tn=AppListingFee`;
    
    document.getElementById('upiPayBtn').href = upiLink;
    document.getElementById('upiPayBtn').innerText = `Pay â‚¹${fee} to Admin`;
    document.getElementById('payTitle').innerText = "Pay Listing Fee";
    document.getElementById('payReceiverInfo').innerText = "Fee goes to Admin";
    document.getElementById('payContext').value = 'upload';

    closeModal('uploadModal');
    document.getElementById('paymentModal').classList.remove('hidden');
}


// =======================================================
// 4. TRANSACTION HANDLER & OTHERS (UNCHANGED)
// =======================================================
const finalizeTransaction = async(e) => {
    e.preventDefault();
    const context = document.getElementById('payContext').value;
    const senderName = document.getElementById('paySenderName').value;
    const senderUpi = document.getElementById('paySenderUpi').value;
    if (!senderName || !senderUpi) return alert("Please fill payment details");
    if (context === 'upload') {
        tempAppData.paymentDetails = { senderName, senderUpi, amountPaid: tempAppData.listingFee, type: 'listing_fee' };
        try {
            await db.collection("apps").add(tempAppData);
            alert('App Submitted for Review!');
            tempAppData = {};
        } catch (err) { alert("Error: " + err.message); }
    } else if (context === 'purchase') {
        const appId = document.getElementById('payTargetId').value;
        const app = apps.find(a => a.id === appId);
        try {
            await db.collection('users').doc(app.uploaderUid).update({ earnings: firebase.firestore.FieldValue.increment(parseInt(app.appPrice)) });
            startDownloadProcess(appId);
            alert("Payment Verified! Download Starting...");
        } catch (err) { console.error(err); alert("Error processing purchase."); }
    }
    closeModal('paymentModal');
};

const initiatePurchase = async(appId) => { const app = apps.find(a => a.id === appId); const devDoc = await db.collection('users').doc(app.uploaderUid).get(); const devData = devDoc.data(); const devUPI = devData.upiId; if (!devUPI) return alert("Developer has not set up a UPI ID."); const upiLink = `upi://pay?pa=${devUPI}&pn=${devData.name}&am=${app.appPrice}&cu=INR&tn=BuyApp-${app.name}`; const payBtn = document.getElementById('upiPayBtn'); payBtn.href = upiLink; payBtn.innerText = `Pay â‚¹${app.appPrice} to Developer`; document.getElementById('payTitle').innerText = `Buy ${app.name}`; document.getElementById('payReceiverInfo').innerText = `Payment goes to: ${devData.name}`; document.getElementById('payContext').value = 'purchase'; document.getElementById('payTargetId').value = appId; closeModal('detailModal'); document.getElementById('paymentModal').classList.remove('hidden'); };
const startDownloadProcess = (id) => { const app = apps.find(a => a.id === id); const btn = document.getElementById('dlBtn'); if (btn) { btn.innerHTML = "Downloading..."; btn.classList.add('download-anim'); } setTimeout(async() => { await db.collection("apps").doc(id).update({ downloads: firebase.firestore.FieldValue.increment(1) }); const a = document.createElement('a'); a.href = app.apkUrl; a.target = "_blank"; a.download = app.name + ".apk"; document.body.appendChild(a); a.click(); document.body.removeChild(a); if (btn) { btn.innerHTML = "Installed!"; btn.classList.remove('download-anim'); } }, 1500); };
const submitReview = async(id) => { const s = parseInt(document.getElementById('rStars').value), c = document.getElementById('rComment').value; if (!c) return alert('Please write a comment'); await db.collection("apps").doc(id).update({ ratings: firebase.firestore.FieldValue.arrayUnion({ stars: s, comment: c, date: new Date().toISOString() }) }); alert("Review Submitted"); openDetail(id); };

// =======================================================
// 5. ADMIN PANEL LOGIC (UNCHANGED)
// =======================================================
const openAdminPrompt = () => document.getElementById('adminLoginModal').classList.remove('hidden');
const checkAdmin = () => { if (document.getElementById('adminPass').value === ADMIN_PASS) { closeModal('adminLoginModal'); document.getElementById('mainView').classList.add('hidden'); document.getElementById('adminPanel').classList.remove('hidden'); showAdminTab('pending'); } else { alert('Incorrect Password'); } };
const exitAdmin = () => { document.getElementById('adminPanel').classList.add('hidden'); document.getElementById('mainView').classList.remove('hidden'); renderHome(); };
const showAdminTab = (tab) => { const container = document.getElementById('adminTabContent'); let content = ''; if (tab === 'pending') { const p = apps.filter(a => a.status === 'pending'); content = `<h3>Pending Payment Verification (${p.length})</h3>`; if (p.length === 0) content += '<p>No pending apps.</p>'; else content += `<table class="admin-table"><tr><th>App</th><th>Payment Details</th><th>Action</th></tr>${p.map(a => `<tr><td><b>${a.name}</b><br>${a.isPremium ? 'Premium' : 'Free'}</td><td style="font-size:0.85rem;">Name: <b>${a.paymentDetails ? a.paymentDetails.senderName : 'N/A'}</b><br>UPI: <b>${a.paymentDetails ? a.paymentDetails.senderUpi : 'N/A'}</b></td><td><button class="btn btn-success" onclick="updateStatus('${a.id}', 'approved')">Verify</button><button class="btn btn-danger" onclick="updateStatus('${a.id}', 'rejected')">Reject</button></td></tr>`).join('')}</table>`; } else if (tab === 'approved') { const p = apps.filter(a => a.status === 'approved'); content = `<h3>Live Apps (${p.length})</h3><table class="admin-table"><tr><th>App</th><th>DLs</th><th>Feat</th><th>Action</th></tr>${p.map(a => `<tr><td>${a.name}</td><td>${a.downloads}</td><td><button onclick="toggleFeature('${a.id}', ${a.featured})">${a.featured ? 'Yes' : 'No'}</button></td><td><button class="btn btn-danger" onclick="deleteApp('${a.id}')">Delete</button></td></tr>`).join('')}</table>`; } else if (tab === 'analytics') { const totalDL = apps.reduce((s, a) => s + (a.downloads || 0), 0); content = `<h3>Analytics</h3><div class="app-card" style="flex-direction:column; gap:20px;"><div><h2>${apps.length}</h2><p>Total Submissions</p></div><div><h2>${totalDL}</h2><p>Total Downloads</p></div></div>`; } container.innerHTML = content; };
const updateStatus = async(id, status) => { if (status === 'rejected') { if (!confirm("Reject this app?")) return; await db.collection("apps").doc(id).delete(); } else { await db.collection("apps").doc(id).update({ status: status }); } showAdminTab('pending'); };
const toggleFeature = async(id, current) => { await db.collection("apps").doc(id).update({ featured: !current }); showAdminTab('approved'); };
const deleteApp = async(id) => { if (confirm('Delete permanently?')) { await db.collection("apps").doc(id).delete(); showAdminTab('approved'); } };

</script>
</body>
</html>
